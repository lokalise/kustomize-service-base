# Kustomize Service Base

<!-- vim-markdown-toc GFM -->

* [Contributing](#contributing)
* [Organization](#organization)
    * [Groups](#groups)
        * [Components](#components)
    * [Collections](#collections)
    * [Versioning](#versioning)

<!-- vim-markdown-toc -->

## Contributing

Use conventional commits, when making changes to assure a good changelog and
versioning: https://www.conventionalcommits.org/en/v1.0.0/#summary

---

The commit contains the following structural elements, to communicate intent to the consumers of your library:

  fix: a commit of the type fix patches a bug in your codebase (this correlates with PATCH in Semantic Versioning).
  Example: `fix: Add default value to field`

  feat: a commit of the type feat introduces a new feature to the codebase (this correlates with MINOR in Semantic Versioning).
  Example: `feat: Introduce new component`

  BREAKING CHANGE: a commit that has a footer BREAKING CHANGE:, or appends a ! after the type/scope, introduces a breaking API change (correlating with MAJOR in Semantic Versioning). A BREAKING CHANGE can be part of commits of any type.
  Example: `BREAKING CHANGE: Restructure`

---

## Organization

Manifests are provided in 2 ways:

### Groups

A narrowly scoped logical set of Kubernetes resources (eg. `Rollout` + `ServiceAccount` + `Service` + `Secret`)

Group | Kubernetes Resources | Description
--- | --- | ---
rollout | `Rollout`<br>`Service`<br>`ServiceAccount`<br>`ServiceMonitor`<br>`ScaledObject`<br>`PodDisruptionBudget`<br>`NetworkPolicy` | All required components for an application, following best practices. No associated ingress.
ingress | `Ingress` | Public Nginx ingress (routable from the Internet).
ingress-internal | `Ingress` | Private Nginx ingress (routable only from within the clusters and Tailscale). Creates 2 ingresses: application, application preview (argo rollout b/g).
job | `Job`, `Secret` | Job which starts in the `PreSync` ArgoCD phase for executing tasks like DB migrations. Runs commands in the app container.
cronjob | `CronJob`, `Secret` | Runs scheduled commands in the app container.
slo | `PrometheusServiceLevel` | [Sloth SLO specification](https://sloth.dev/examples/default/getting-started/) from which `PrometheusRule` resources are generated by the `sloth` controller.
karpenter | `Provisioner` | [Karpenter](https://karpenter.sh/) provisioner for autoscaling workloads.

Usage:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/lokalise/kustomize-service-base/manifests/groups/rollout
- github.com/lokalise/kustomize-service-base/manifests/groups/ingress
- github.com/lokalise/kustomize-service-base/manifests/groups/ingress-internal
- github.com/lokalise/kustomize-service-base/manifests/groups/job
- github.com/lokalise/kustomize-service-base/manifests/groups/cronjob
- github.com/lokalise/kustomize-service-base/manifests/groups/slo

## Optional: REMOVE RESOURCES INCLUDED FROM THE BASE
# patches:
# - target:
#    kind: Ingress
#    group: networking.k8s.io
#   patch: |-
#     $patch: delete
#     kind: Ingress
#     metadata:
#       name: all # this is just to satisfy the patch format; 'target' above defines which objects to patch
```

#### Components

[Components](https://kubectl.docs.kubernetes.io/guides/config_management/components/) are a way to package up patches, providing "variants" of existing resources.

Component | Applies to Group(s) | Description
--- | --- | ---
no-tls | ingress-internal | Updates the `ingressClassName` to `nginx-internal-http`, which is a TLS-disabled, internal ingress controller.
http | slo | Updates the `slo[0, 1].sli.plugin` to `lokalise/http/availability`, which [supports](https://github.com/lokalise/common-sloth-sli-plugins/tree/main/plugins/http) setting a route regex for the SLO.
autoscaling | rollout | Includes a `ScaledObject` (Keda), which creates an `HPA` in the backgroun used for automatic scaling of Pods.

Usage:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - github.com/lokalise/kustomize-service-base/manifests/groups/ingress-internal?ref=v2.1.0
  ...

components:
  - github.com/lokalise/kustomize-service-base/manifests/groups/ingress-internal/components/no-tls?ref=v2.1.0
```

### Collections

A set of groups, supporting a particular usage like services based on the Node service template

Collection | Groups included | Description
--- | --- | ---
node-service | `rollout`<br>`ingress-internal`<br>`job`<br>`slo` | Supporting a standard service based on the `node-service-template`

Usage:

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- github.com/lokalise/kustomize-service-base/manifests/collections/node-service@v2.0.0

## Optional: REMOVE RESOURCES INCLUDED FROM THE BASE
# patches:
# - target:
#    kind: Ingress
#    group: networking.k8s.io
#   patch: |-
#     $patch: delete
#     kind: Ingress
#     metadata:
#       name: all # this is just to satisfy the patch format; 'target' above defines which objects to patch
```

### Versioning

The repository is versioned with a global tag (eg. `v2.0.0`) using [release-please](https://github.com/googleapis/release-please). See [this page](https://github.com/lokalise/platform-handbook/blob/main/adr/0001-std-gh-repos.md#versioning) for the complete flow.
